#!/usr/bin/env node
"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const prompt = require('prompt');
const fs = require('fs');
const os = require('os');
const child_process = require("child_process");
const colors_1 = require("colors");
const safe_1 = require("colors/safe");
const nem_library_1 = require("nem-library");
const wallet_1 = require("../src/wallet/wallet");
const CFonts = require('cfonts');
const Spinner = require('cli-spinner').Spinner;
const args = process.argv.slice(2);
const homePath = `${os.homedir()}/cache-wallets`;
let defaultWalletPath;
if (args.length === 0) {
    CFonts.say('Cache', { colors: ['cyan'] });
    console.log(`Usage:

	cache wallet list
		Lists all of the wallets available in your cache-wallets directory
	
	cache wallet default <number>
		Choose the wallet you want to set as default ie 'cache wallet default 3'
	
	cache balance
		Gets your current wallet balance and public address
	
	cache send <amount> <address>
		Sends cache from your wallet to the specified address
	
	cache wallet create
		Guides you through creating a new cache wallet
	`);
    process.exit(1);
}
const downloadWallet = (wallet, address) => {
    console.log(colors_1.white(`\n\nDownloading wallet for your convenience.\n\nPlease store someplace safe. The private key is encrypted by your password.\n\nTo load this wallet on a new computer you would simply import the .wlt file into this app and enter your password and you'll be able to sign transactions.
	`));
    const addAbb = address.substring(0, 6);
    const stamp = new Date().toISOString().substring(0, 10);
    if (!fs.existsSync(homePath)) {
        fs.mkdirSync(homePath);
    }
    const path = `${homePath}/${addAbb}-${stamp}-cache.wlt`;
    fs.writeFile(path, wallet.writeWLTFile(), (_) => {
        console.log(safe_1.green(`\nDownloaded wallet to ${path}\n`));
    });
};
const createPwd = () => {
    console.log(colors_1.white(`\nPlease enter a unique password ${safe_1.yellow('(8 character minimum)')}.\n 
This password will be used to encrypt your private key and make working with your wallet easier.\n\n`));
    console.log(safe_1.red(`Store this password somewhere safe. If you lose or forget it you will never be able to transfer funds\n`));
    prompt.message = colors_1.white('Cache Wallet');
    prompt.start();
    prompt.get({
        properties: {
            password: {
                description: colors_1.white('Password'),
                hidden: true
            },
            confirmPass: {
                description: colors_1.white('Re-enter password'),
                hidden: true
            }
        }
    }, (_, result) => __awaiter(this, void 0, void 0, function* () {
        if (result.password !== result.confirmPass) {
            console.log(safe_1.magenta('\nPasswords do not match.\n\n'));
            createPwd();
        }
        else {
            const wallet = wallet_1.createSimpleWallet(result.password);
            const pass = new nem_library_1.Password(result.password);
            const account = wallet.open(pass);
            const address = account.address.pretty();
            console.log(safe_1.green('\nCache wallet successfully created.\n'));
            console.log(colors_1.white('You can now start sending and receiving cache!\n'));
            console.log(colors_1.white(`\nCache Public Address:`));
            console.log(safe_1.yellow(`${address}`));
            console.log(colors_1.white(`\nPrivate Key:`));
            console.log(safe_1.yellow(`${account.privateKey}`));
            yield downloadWallet(wallet, address);
        }
    }));
};
const listWallets = () => {
    console.log(colors_1.white('Fetching wallets...\n'));
    loadWalletPaths(paths => {
        if (paths.length === 0) {
            console.log(colors_1.white(`No wallets found. Create a new wallet or place an existing .wlt file
in ${homePath}\n`));
            process.exit(1);
        }
        for (let x = 0; x < paths.length; x++) {
            console.log(`${x} - ${paths[x]}`);
        }
        console.log('\n');
    });
};
const loadWalletPaths = (onLoaded) => {
    fs.readdir(homePath, (_, files) => {
        let paths = [];
        for (let x = 0; x < files.length; x++) {
            if (files[x].includes('default')) {
                defaultWalletPath = files[x];
            }
            const str = files[x].substring(files[x].length - 3, files[x].length);
            if (str === 'wlt') {
                paths.push(files[x]);
            }
        }
        onLoaded(paths);
    });
};
const attemptWalletOpen = (wallet) => {
    return new Promise((resolve, reject) => {
        prompt.start();
        prompt.get({
            properties: {
                password: {
                    description: colors_1.white('Password'),
                    hidden: true
                }
            }
        }, (_, result) => {
            const pass = new nem_library_1.Password(result);
            try {
                resolve(wallet.open(pass));
            }
            catch (err) {
                console.log(safe_1.red(`${err}`));
                console.log(colors_1.white('Please try again'));
                reject();
            }
        });
    });
};
const loadWallet = () => {
    loadWalletPaths(_ => { });
    child_process.execSync('sleep 1');
    const fullPath = `${homePath}/${defaultWalletPath}`;
    const contents = fs.readFileSync(fullPath, 'utf8');
    return nem_library_1.SimpleWallet.readFromWLT(contents);
};
const getBalance = () => __awaiter(this, void 0, void 0, function* () {
    const wallet = loadWallet();
    try {
        const account = yield attemptWalletOpen(wallet);
        const spinner = new Spinner('processing.. %s');
        spinner.setSpinnerString(9);
        spinner.start();
        const cacheMosaic = yield wallet_1.getAccountBalance(account);
        const balance = cacheMosaic ? cacheMosaic.quantity : 0;
        spinner.stop();
        const bal = Math.round(balance * 1e6) / 1e6;
        console.log(safe_1.green('\n\nCache Balance: '));
        console.log(colors_1.white(`${bal}\n`));
    }
    catch (err) {
        if (err) {
            console.log(err);
        }
        getBalance();
    }
});
const setDefaultWallet = (walletIndex) => {
    loadWalletPaths(paths => {
        if (paths[walletIndex].includes('default'))
            return;
        for (let x = 0; x < paths.length; x++) {
            let newPath = paths[x].replace('default-', '');
            newPath = `${homePath}/${newPath}`;
            fs.rename(`${homePath}/${paths[x]}`, newPath, (_) => { });
        }
        setTimeout(() => {
            fs.rename(`${homePath}/${paths[walletIndex]}`, `${homePath}/default-${paths[walletIndex]}`);
        }, 800);
    });
};
const main = () => {
    loadWalletPaths(paths => {
        if (args[0] === 'wallet') {
            if (args[1] === 'create') {
                createPwd();
            }
            else if (args[1] === 'balance') {
                if (!defaultWalletPath) {
                    return console.log(safe_1.yellow(`\nYou must first set a default wallet. Run ${colors_1.white('cache wallet list')} then ${colors_1.white('cache wallet default <number>')}\n`));
                }
                getBalance();
            }
            else if (args[1] === 'list') {
                listWallets();
            }
            else if (args[1] === 'default') {
                const idx = parseInt(args[2]);
                if (isNaN(idx)) {
                    console.log(safe_1.red('Invalid wallet index. Must be an Integer'));
                }
                else {
                    if (idx >= 0 && idx < paths.length) {
                        setDefaultWallet(idx);
                    }
                    else {
                        console.log(safe_1.red('Invalid wallet selection'));
                    }
                }
            }
        }
    });
};
main();
process.on('uncaughtException', function (err) {
    console.log(err);
    console.log('Wallet closed');
    process.exit(1);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2FsbGV0LWNsaS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIndhbGxldC1jbGkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFDQSxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDakMsTUFBTSxFQUFFLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3pCLE1BQU0sRUFBRSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUN6QixNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7QUFDL0MsbUNBQStCO0FBQy9CLHNDQUEwRDtBQUMxRCw2Q0FBOEQ7QUFDOUQsaURBQTZFO0FBQzdFLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNqQyxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUMsT0FBTyxDQUFDO0FBRy9DLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ25DLE1BQU0sUUFBUSxHQUFHLEdBQUcsRUFBRSxDQUFDLE9BQU8sRUFBRSxnQkFBZ0IsQ0FBQztBQUNqRCxJQUFJLGlCQUF5QixDQUFDO0FBRTlCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN2QixNQUFNLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxFQUFFLE1BQU0sRUFBRSxDQUFDLE1BQU0sQ0FBQyxFQUFDLENBQUMsQ0FBQztJQUN6QyxPQUFPLENBQUMsR0FBRyxDQUFDOzs7Ozs7Ozs7Ozs7Ozs7O0VBZ0JYLENBQUMsQ0FBQztJQUNILE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDakIsQ0FBQztBQUVELE1BQU0sY0FBYyxHQUFHLENBQUMsTUFBb0IsRUFBRSxPQUFlLEVBQUUsRUFBRTtJ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L2VudiBub2RlXG5jb25zdCBwcm9tcHQgPSByZXF1aXJlKCdwcm9tcHQnKTtcbmNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKTtcbmNvbnN0IG9zID0gcmVxdWlyZSgnb3MnKTtcbmNvbnN0IGNoaWxkX3Byb2Nlc3MgPSByZXF1aXJlKFwiY2hpbGRfcHJvY2Vzc1wiKTtcbmltcG9ydCB7IHdoaXRlIH0gZnJvbSAnY29sb3JzJztcbmltcG9ydCB7IGdyZWVuLCBtYWdlbnRhLCByZWQsIHllbGxvdyB9IGZyb20gJ2NvbG9ycy9zYWZlJztcbmltcG9ydCB7IFBhc3N3b3JkLCBTaW1wbGVXYWxsZXQsIEFjY291bnQgfSBmcm9tICduZW0tbGlicmFyeSc7XG5pbXBvcnQgeyBjcmVhdGVTaW1wbGVXYWxsZXQsIGdldEFjY291bnRCYWxhbmNlIH0gZnJvbSAnLi4vc3JjL3dhbGxldC93YWxsZXQnO1xuY29uc3QgQ0ZvbnRzID0gcmVxdWlyZSgnY2ZvbnRzJyk7XG5jb25zdCBTcGlubmVyID0gcmVxdWlyZSgnY2xpLXNwaW5uZXInKS5TcGlubmVyO1xuXG5kZWNsYXJlIGxldCBwcm9jZXNzOiBhbnk7XG5jb25zdCBhcmdzID0gcHJvY2Vzcy5hcmd2LnNsaWNlKDIpO1xuY29uc3QgaG9tZVBhdGggPSBgJHtvcy5ob21lZGlyKCl9L2NhY2hlLXdhbGxldHNgO1xubGV0IGRlZmF1bHRXYWxsZXRQYXRoOiBzdHJpbmc7XG5cbmlmIChhcmdzLmxlbmd0aCA9PT0gMCkge1xuXHRDRm9udHMuc2F5KCdDYWNoZScsIHsgY29sb3JzOiBbJ2N5YW4nXX0pO1xuXHRjb25zb2xlLmxvZyhgVXNhZ2U6XG5cblx0Y2FjaGUgd2FsbGV0IGxpc3Rcblx0XHRMaXN0cyBhbGwgb2YgdGhlIHdhbGxldHMgYXZhaWxhYmxlIGluIHlvdXIgY2FjaGUtd2FsbGV0cyBkaXJlY3Rvcnlcblx0XG5cdGNhY2hlIHdhbGxldCBkZWZhdWx0IDxudW1iZXI+XG5cdFx0Q2hvb3NlIHRoZSB3YWxsZXQgeW91IHdhbnQgdG8gc2V0IGFzIGRlZmF1bHQgaWUgJ2NhY2hlIHdhbGxldCBkZWZhdWx0IDMnXG5cdFxuXHRjYWNoZSBiYWxhbmNlXG5cdFx0R2V0cyB5b3VyIGN1cnJlbnQgd2FsbGV0IGJhbGFuY2UgYW5kIHB1YmxpYyBhZGRyZXNzXG5cdFxuXHRjYWNoZSBzZW5kIDxhbW91bnQ+IDxhZGRyZXNzPlxuXHRcdFNlbmRzIGNhY2hlIGZyb20geW91ciB3YWxsZXQgdG8gdGhlIHNwZWNpZmllZCBhZGRyZXNzXG5cdFxuXHRjYWNoZSB3YWxsZXQgY3JlYXRlXG5cdFx0R3VpZGVzIHlvdSB0aHJvdWdoIGNyZWF0aW5nIGEgbmV3IGNhY2hlIHdhbGxldFxuXHRgKTtcblx0cHJvY2Vzcy5leGl0KDEpO1xufVxuXG5jb25zdCBkb3dubG9hZFdhbGxldCA9ICh3YWxsZXQ6IFNpbXBsZVdhbGxldCwgYWRkcmVzczogc3RyaW5nKSA9PiB7XG5cdGNvbnNvbGUubG9nKHdoaXRlKGBcXG5cXG5Eb3dubG9hZGluZyB3YWxsZXQgZm9yIHlvdXIgY29udmVuaWVuY2UuXFxuXFxuUGxlYXNlIHN0b3JlIHNvbWVwbGFjZSBzYWZlLiBUaGUgcHJpdmF0ZSBrZXkgaXMgZW5jcnlwdGVkIGJ5IHlvdXIgcGFzc3dvcmQuXFxuXFxuVG8gbG9hZCB0aGlzIHdhbGxldCBvbiBhIG5ldyBjb21wdXRlciB5b3Ugd291bGQgc2ltcGx5IGltcG9ydCB0aGUgLndsdCBmaWxlIGludG8gdGhpcyBhcHAgYW5kIGVudGVyIHlvdXIgcGFzc3dvcmQgYW5kIHlvdSdsbCBiZSBhYmxlIHRvIHNpZ24gdHJhbnNhY3Rpb25zLlxuXHRgKSk7XG5cdGNvbnN0IGFkZEFiYiA9IGFkZHJlc3Muc3Vic3RyaW5nKDAsNik7XG5cdGNvbnN0IHN0YW1wID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpLnN1YnN0cmluZygwLDEwKTtcblxuXHRpZiAoIWZzLmV4aXN0c1N5bmMoaG9tZVBhdGgpKSB7XG5cdFx0ZnMubWtkaXJTeW5jKGhvbWVQYXRoKTtcblx0fVxuXHRjb25zdCBwYXRoID0gYCR7aG9tZVBhdGh9LyR7YWRkQWJifS0ke3N0YW1wfS1jYWNoZS53bHRgO1xuXHRmcy53cml0ZUZpbGUocGF0aCwgd2FsbGV0LndyaXRlV0xURmlsZSgpLCAoXykgPT4ge1xuXHRcdGNvbnNvbGUubG9nKGdyZWVuKGBcXG5Eb3dubG9hZGVkIHdhbGxldCB0byAke3BhdGh9XFxuYCkpO1xuXHR9KTtcbn07XG5cbmNvbnN0IGNyZWF0ZVB3ZCA9ICgpID0+IHtcblx0Y29uc29sZS5sb2cod2hpdGUoXG5gXFxuUGxlYXNlIGVudGVyIGEgdW5pcXVlIHBhc3N3b3JkICR7eWVsbG93KCcoOCBjaGFyYWN0ZXIgbWluaW11bSknKX0uXFxuIFxuVGhpcyBwYXNzd29yZCB3aWxsIGJlIHVzZWQgdG8gZW5jcnlwdCB5b3VyIHByaXZhdGUga2V5IGFuZCBtYWtlIHdvcmtpbmcgd2l0aCB5b3VyIHdhbGxldCBlYXNpZXIuXFxuXFxuYFxuXHQpKTtcblx0Y29uc29sZS5sb2cocmVkKFxuXHRcdGBTdG9yZSB0aGlzIHBhc3N3b3JkIHNvbWV3aGVyZSBzYWZlLiBJZiB5b3UgbG9zZSBvciBmb3JnZXQgaXQgeW91IHdpbGwgbmV2ZXIgYmUgYWJsZSB0byB0cmFuc2ZlciBmdW5kc1xcbmBcblx0KSk7XG5cdHByb21wdC5tZXNzYWdlID0gd2hpdGUoJ0NhY2hlIFdhbGxldCcpO1xuXHRwcm9tcHQuc3RhcnQoKTtcblx0cHJvbXB0LmdldCh7XG5cdFx0cHJvcGVydGllczoge1xuXHRcdFx0cGFzc3dvcmQ6IHtcblx0XHRcdFx0ZGVzY3JpcHRpb246IHdoaXRlKCdQYXNzd29yZCcpLFxuXHRcdFx0XHRoaWRkZW46IHRydWVcblx0XHRcdH0sXG5cdFx0XHRjb25maXJtUGFzczoge1xuXHRcdFx0XHRkZXNjcmlwdGlvbjogd2hpdGUoJ1JlLWVudGVyIHBhc3N3b3JkJyksXG5cdFx0XHRcdGhpZGRlbjogdHJ1ZVxuXHRcdFx0fVxuXHRcdH1cblx0fSwgYXN5bmMgKF8sIHJlc3VsdCkgPT4ge1xuXHRcdGlmIChyZXN1bHQucGFzc3dvcmQgIT09IHJlc3VsdC5jb25maXJtUGFzcykge1xuXHRcdFx0Y29uc29sZS5sb2cobWFnZW50YSgnXFxuUGFzc3dvcmRzIGRvIG5vdCBtYXRjaC5cXG5cXG4nKSk7XG5cdFx0XHRjcmVhdGVQd2QoKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Y29uc3Qgd2FsbGV0ID0gY3JlYXRlU2ltcGxlV2FsbGV0KHJlc3VsdC5wYXNzd29yZCk7XG5cdFx0XHRjb25zdCBwYXNzID0gbmV3IFBhc3N3b3JkKHJlc3VsdC5wYXNzd29yZCk7XG5cdFx0XHRjb25zdCBhY2NvdW50ID0gd2FsbGV0Lm9wZW4ocGFzcyk7XG5cdFx0XHRjb25zdCBhZGRyZXNzID0gYWNjb3VudC5hZGRyZXNzLnByZXR0eSgpO1xuXHRcdFx0Y29uc29sZS5sb2coZ3JlZW4oJ1xcbkNhY2hlIHdhbGxldCBzdWNjZXNzZnVsbHkgY3JlYXRlZC5cXG4nKSk7XG5cdFx0XHRjb25zb2xlLmxvZyh3aGl0ZSgnWW91IGNhbiBub3cgc3RhcnQgc2VuZGluZyBhbmQgcmVjZWl2aW5nIGNhY2hlIVxcbicpKTtcblx0XHRcdGNvbnNvbGUubG9nKHdoaXRlKGBcXG5DYWNoZSBQdWJsaWMgQWRkcmVzczpgKSk7XG5cdFx0XHRjb25zb2xlLmxvZyh5ZWxsb3coYCR7YWRkcmVzc31gKSk7XG5cdFx0XHRjb25zb2xlLmxvZyh3aGl0ZShgXFxuUHJpdmF0ZSBLZXk6YCkpO1xuXHRcdFx0Y29uc29sZS5sb2coeWVsbG93KGAke2FjY291bnQucHJpdmF0ZUtleX1gKSk7XG5cdFx0XHRhd2FpdCBkb3dubG9hZFdhbGxldCh3YWxsZXQsIGFkZHJlc3MpO1xuXHRcdH1cblx0fSlcbn07XG5cbmNvbnN0IGxpc3RXYWxsZXRzID0gKCkgPT4ge1xuXHRjb25zb2xlLmxvZyh3aGl0ZSgnRmV0Y2hpbmcgd2FsbGV0cy4uLlxcbicpKTtcblxuXHRsb2FkV2FsbGV0UGF0aHMocGF0aHMgPT4ge1xuXHRcdGlmIChwYXRocy5sZW5ndGggPT09IDApIHtcblx0XHRcdGNvbnNvbGUubG9nKHdoaXRlKGBObyB3YWxsZXRzIGZvdW5kLiBDcmVhdGUgYSBuZXcgd2FsbGV0IG9yIHBsYWNlIGFuIGV4aXN0aW5nIC53bHQgZmlsZVxuaW4gJHtob21lUGF0aH1cXG5gKSk7XG5cdFx0XHRwcm9jZXNzLmV4aXQoMSk7XG5cdFx0fVxuXHRcdGZvciAobGV0IHggPSAwOyB4IDwgcGF0aHMubGVuZ3RoOyB4KyspIHtcblx0XHRcdGNvbnNvbGUubG9nKGAke3h9IC0gJHtwYXRoc1t4XX1gKTtcblx0XHR9XG5cdFx0Y29uc29sZS5sb2coJ1xcbicpXG5cdH0pO1xufTtcblxuY29uc3QgbG9hZFdhbGxldFBhdGhzID0gKG9uTG9hZGVkOiAocGF0aHM6IEFycmF5PHN0cmluZz4pID0+IHZvaWQpID0+IHtcblx0ZnMucmVhZGRpcihob21lUGF0aCwgKF8sIGZpbGVzKSA9PiB7XG5cdFx0bGV0IHBhdGhzOiBBcnJheTxzdHJpbmc+ID0gW107XG5cdFx0Zm9yIChsZXQgeCA9IDA7IHggPCBmaWxlcy5sZW5ndGg7IHgrKykge1xuXHRcdFx0aWYgKGZpbGVzW3hdLmluY2x1ZGVzKCdkZWZhdWx0JykpIHtcblx0XHRcdFx0ZGVmYXVsdFdhbGxldFBhdGggPSBmaWxlc1t4XTtcblx0XHRcdH1cblx0XHRcdGNvbnN0IHN0ciA9IGZpbGVzW3hdLnN1YnN0cmluZyhmaWxlc1t4XS5sZW5ndGggLSAzLCBmaWxlc1t4XS5sZW5ndGgpO1xuXHRcdFx0aWYgKHN0ciA9PT0gJ3dsdCcpIHtcblx0XHRcdFx0cGF0aHMucHVzaChmaWxlc1t4XSk7XG5cdFx0XHR9XG5cdFx0fVxuXHRcdG9uTG9hZGVkKHBhdGhzKTtcblx0fSk7XG59O1xuY29uc3QgYXR0ZW1wdFdhbGxldE9wZW4gPSAod2FsbGV0OiBTaW1wbGVXYWxsZXQpOiBQcm9taXNlPEFjY291bnQ+ID0+IHtcblx0cmV0dXJuIG5ldyBQcm9taXNlPEFjY291bnQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHRwcm9tcHQuc3RhcnQoKTtcblx0XHRwcm9tcHQuZ2V0KHtcblx0XHRcdHByb3BlcnRpZXM6IHtcblx0XHRcdFx0cGFzc3dvcmQ6IHtcblx0XHRcdFx0XHRkZXNjcmlwdGlvbjogd2hpdGUoJ1Bhc3N3b3JkJyksXG5cdFx0XHRcdFx0aGlkZGVuOiB0cnVlXG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9LCAoXywgcmVzdWx0KSA9PiB7XG5cdFx0XHRjb25zdCBwYXNzID0gbmV3IFBhc3N3b3JkKHJlc3VsdCk7XG5cdFx0XHR0cnkge1xuXHRcdFx0XHRyZXNvbHZlKHdhbGxldC5vcGVuKHBhc3MpKTtcblx0XHRcdH0gY2F0Y2ggKGVycikge1xuXHRcdFx0XHRjb25zb2xlLmxvZyhyZWQoYCR7ZXJyfWApKTtcblx0XHRcdFx0Y29uc29sZS5sb2cod2hpdGUoJ1BsZWFzZSB0cnkgYWdhaW4nKSk7XG5cdFx0XHRcdHJlamVjdCgpO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHR9KTtcbn07XG5jb25zdCBsb2FkV2FsbGV0ID0gKCk6IFNpbXBsZVdhbGxldCA9PiB7XG5cdGxvYWRXYWxsZXRQYXRocyhfID0+IHt9KTtcblx0Y2hpbGRfcHJvY2Vzcy5leGVjU3luYygnc2xlZXAgMScpO1xuXHRjb25zdCBmdWxsUGF0aCA9IGAke2hvbWVQYXRofS8ke2RlZmF1bHRXYWxsZXRQYXRofWA7XG5cdGNvbnN0IGNvbnRlbnRzID0gZnMucmVhZEZpbGVTeW5jKGZ1bGxQYXRoLCAndXRmOCcpO1xuXHRyZXR1cm4gU2ltcGxlV2FsbGV0LnJlYWRGcm9tV0xUKGNvbnRlbnRzKTtcbn07XG5jb25zdCBnZXRCYWxhbmNlID0gYXN5bmMgKCkgPT4ge1xuXHRjb25zdCB3YWxsZXQgPSBsb2FkV2FsbGV0KCk7XG5cdHRyeSB7XG5cdFx0Y29uc3QgYWNjb3VudCA9IGF3YWl0IGF0dGVtcHRXYWxsZXRPcGVuKHdhbGxldCk7XG5cdFx0Y29uc3Qgc3Bpbm5lciA9IG5ldyBTcGlubmVyKCdwcm9jZXNzaW5nLi4gJXMnKTtcblx0XHRzcGlubmVyLnNldFNwaW5uZXJTdHJpbmcoOSk7XG5cdFx0c3Bpbm5lci5zdGFydCgpO1xuXHRcdGNvbnN0IGNhY2hlTW9zYWljID0gYXdhaXQgZ2V0QWNjb3VudEJhbGFuY2UoYWNjb3VudCk7XG5cdFx0Y29uc3QgYmFsYW5jZSA9IGNhY2hlTW9zYWljID8gY2FjaGVNb3NhaWMucXVhbnRpdHkgOiAwO1xuXHRcdHNwaW5uZXIuc3RvcCgpO1xuXHRcdGNvbnN0IGJhbCA9IE1hdGgucm91bmQoYmFsYW5jZSAqIDFlNikgLyAxZTY7XG5cblx0XHRjb25zb2xlLmxvZyhncmVlbignXFxuXFxuQ2FjaGUgQmFsYW5jZTogJykpO1xuXHRcdGNvbnNvbGUubG9nKHdoaXRlKGAke2JhbH1cXG5gKSk7XG5cdH0gY2F0Y2ggKGVycikge1xuXHRcdGlmIChlcnIpIHtcblx0XHRcdGNvbnNvbGUubG9nKGVycik7XG5cdFx0fVxuXHRcdGdldEJhbGFuY2UoKTtcblx0fVxufTtcbmNvbnN0IHNldERlZmF1bHRXYWxsZXQgPSAod2FsbGV0SW5kZXg6IG51bWJlcikgPT4ge1xuXHRsb2FkV2FsbGV0UGF0aHMocGF0aHMgPT4ge1xuXHRcdGlmIChwYXRoc1t3YWxsZXRJbmRleF0uaW5jbHVkZXMoJ2RlZmF1bHQnKSkgcmV0dXJuO1xuXHRcdGZvciAobGV0IHggPSAwOyB4IDwgcGF0aHMubGVuZ3RoOyB4KyspIHtcblx0XHRcdGxldCBuZXdQYXRoID0gcGF0aHNbeF0ucmVwbGFjZSgnZGVmYXVsdC0nLCcnKTtcblx0XHRcdG5ld1BhdGggPSBgJHtob21lUGF0aH0vJHtuZXdQYXRofWA7XG5cdFx0XHRmcy5yZW5hbWUoYCR7aG9tZVBhdGh9LyR7cGF0aHNbeF19YCwgbmV3UGF0aCwgKF8pID0+IHt9KTtcblx0XHR9XG5cdFx0c2V0VGltZW91dCgoKSA9PiB7XG5cdFx0XHRmcy5yZW5hbWUoYCR7aG9tZVBhdGh9LyR7cGF0aHNbd2FsbGV0SW5kZXhdfWAsIGAke2hvbWVQYXRofS9kZWZhdWx0LSR7cGF0aHNbd2FsbGV0SW5kZXhdfWApXG5cdFx0fSwgODAwKTtcblx0fSk7XG59O1xuY29uc3QgbWFpbiA9ICgpID0+IHtcblx0bG9hZFdhbGxldFBhdGhzKHBhdGhzID0+IHtcblx0XHRpZiAoYXJnc1swXSA9PT0gJ3dhbGxldCcpIHtcblx0XHRcdGlmIChhcmdzWzFdID09PSAnY3JlYXRlJykge1xuXHRcdFx0XHRjcmVhdGVQd2QoKTtcblx0XHRcdH0gZWxzZSBpZiAoYXJnc1sxXSA9PT0gJ2JhbGFuY2UnKSB7XG5cdFx0XHRcdGlmICghZGVmYXVsdFdhbGxldFBhdGgpIHtcblx0XHRcdFx0XHRyZXR1cm4gY29uc29sZS5sb2coeWVsbG93KGBcXG5Zb3UgbXVzdCBmaXJzdCBzZXQgYSBkZWZhdWx0IHdhbGxldC4gUnVuICR7d2hpdGUoJ2NhY2hlIHdhbGxldCBsaXN0Jyl9IHRoZW4gJHt3aGl0ZSgnY2FjaGUgd2FsbGV0IGRlZmF1bHQgPG51bWJlcj4nKX1cXG5gKSk7XG5cdFx0XHRcdH1cblx0XHRcdFx0Z2V0QmFsYW5jZSgpO1xuXHRcdFx0fSBlbHNlIGlmIChhcmdzWzFdID09PSAnbGlzdCcpIHtcblx0XHRcdFx0bGlzdFdhbGxldHMoKTtcblx0XHRcdH0gZWxzZSBpZiAoYXJnc1sxXSA9PT0gJ2RlZmF1bHQnKSB7XG5cdFx0XHRcdGNvbnN0IGlkeCA9IHBhcnNlSW50KGFyZ3NbMl0pO1xuXHRcdFx0XHRpZiAoaXNOYU4oaWR4KSkge1xuXHRcdFx0XHRcdGNvbnNvbGUubG9nKHJlZCgnSW52YWxpZCB3YWxsZXQgaW5kZXguIE11c3QgYmUgYW4gSW50ZWdlcicpKVxuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdGlmIChpZHggPj0gMCAmJiBpZHggPCBwYXRocy5sZW5ndGgpIHtcblx0XHRcdFx0XHRcdHNldERlZmF1bHRXYWxsZXQoaWR4KTtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0Y29uc29sZS5sb2cocmVkKCdJbnZhbGlkIHdhbGxldCBzZWxlY3Rpb24nKSlcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9XG5cdH0pO1xufTtcblxubWFpbigpO1xuXG5wcm9jZXNzLm9uKCd1bmNhdWdodEV4Y2VwdGlvbicsIGZ1bmN0aW9uKGVycikge1xuXHRjb25zb2xlLmxvZyhlcnIpO1xuXHRjb25zb2xlLmxvZygnV2FsbGV0IGNsb3NlZCcpO1xuXHRwcm9jZXNzLmV4aXQoMSk7XG59KTsiXX0=